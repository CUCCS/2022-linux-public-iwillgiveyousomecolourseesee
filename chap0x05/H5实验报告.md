## Linux系统与网络管理——H5实验报告 

**实验环境**

+ 主机`win10`系统
+ 虚拟机 `Ubuntu 20.0.04`
+ `Nginx`
+ `VeryNginx`
+ `Wordpress4.7`
+ `DVWA`

**实验内容**

1. 基本要求
   + 在一台主机（虚拟机）上同时配置`Nginx`和`VeryNginx`
     - `VeryNginx`作为本次实验的`Web App`的反向代理服务器和`WAF`
     - `PHP-FPM`进程的反向代理配置在`nginx`服务器上，`VeryNginx`服务器不直接配置Web站点服务
   + 使用[`Wordpress`](https://wordpress.org/)搭建的站点对外提供访问的地址为： http://wp.sec.cuc.edu.cn
   + 使用[Damn Vulnerable Web Application (`DVWA`)](http://www.dvwa.co.uk/)搭建的站点对外提供访问的地址为： http://dvwa.sec.cuc.edu.cn

2. 安全加固要求
   - 使用`IP`地址方式均无法访问上述任意站点，并向访客展示自定义的**友好错误提示信息页面-1**
   - [Damn Vulnerable Web Application (`DVWA`)](http://www.dvwa.co.uk/)只允许白名单上的访客来源`IP`，其他来源的`IP`访问均向访客展示自定义的**友好错误提示信息页面-2**
   - 在不升级`Wordpress`版本的情况下，通过定制[`VeryNginx`](https://github.com/alexazhou/VeryNginx)的访问控制策略规则，**热**修复[`WordPress < 4.7.1 - Username Enumeration`](https://www.exploit-db.com/exploits/41497/)
   - 通过配置[`VeryNginx`](https://github.com/alexazhou/VeryNginx)的Filter规则实现对[Damn Vulnerable Web Application (`DVWA`)](http://www.dvwa.co.uk/)的`SQL`注入实验在低安全等级条件下进行防护
3. `VeryNginx` 配置要求
   - [`VeryNginx`](https://github.com/alexazhou/VeryNginx)的Web管理页面仅允许白名单上的访客来源`IP`，其他来源的`IP`访问均向访客展示自定义的**友好错误提示信息页面-3**
   - 通过定制`VeryNginx`的访问控制策略规则实现：
     - 限制`DVWA`站点的单`IP`访问速率为每秒请求数 < 50
     - 限制`Wordpress`站点的单`IP`访问速率为每秒请求数 < 20
     - 超过访问频率限制的请求直接返回自定义**错误提示信息页面-4**
     - 禁止curl访问

**实验过程**

1. 实验所需软件安装

   + 安装并配置`Nginx`

     ```
     #安装
     sudo apt install nginx
     ```

   + 安装`VeryNginx`

     ```
     #安装git
     sudo apt install git
     
     #将VeryNginx仓库克隆到 Linux，并下载 VeryNginx 安装包
     git clone https://github.com/alexazhou/VeryNginx.git
     
     #安装相关依赖包
     sudo apt-get install libssl-dev -y
     sudo apt install libpcre3 libpcre3-dev -y
     sudo apt install build-essential -y
     sudo apt install zlib1g-dev -y
     sudo apt install gcc -y
     sudo apt install make -y
     
     #进入仓库
     cd VeryNginx
     
     #防止安装verynginx时后端口被占用，先停止监听
     sudo nginx -s stop
     
     #安装veryNginx
     sudo python3 install.py install
     ```

   + 安装`PHP`及相关组件

     ```
     #安装PHP
     sudo apt install php-fpm php-mysql php-curl php-gd php-intl php-mbstring php-soap php-xml php-xmlrpc php-zip -y
     
     #安装完扩展后，重新启动 PHP-FPM 进程，以便正在运行的 PHP 处理器可以利用新安装的功能
     sudo systemctl restart php7.4-fpm
     ```

   + 下载 `WordPress`

     ```
     # 下载安装包
     sudo wget https://wordpress.org/wordpress-4.7.zip
     
     # 解压
     sudo apt install p7zip-full -y
     7z x wordpress-4.7.zip
     
     #建立目录
     sudo mkdir /var/www/html/wp.sec.cuc.edu.cn
     
     # 将解压后的wordpress移至指定路径
     sudo cp -r wordpress /var/www/html/wp.sec.cuc.edu.cn
     ```

   + 下载 `Mysql`

     ```
     #安装MySQL
     sudo apt install mysql-server -y 
     ```

   + 下载 `DVWA`

     ```
     # 下载
     git clone https://github.com/digininja/DVWA.git
     
     # 建立目录
     sudo mkdir /var/www/html/dvwa.sec.cuc.edu.cn
     
     # 把下载好的DVWA移到刚刚创建的目录下
     sudo mv DVWA/* /var/www/html/dvwa.sec.cuc.edu.cn
     ```

2. 配置文件、搭建环境

   + 修改主机hosts文件

     ```
     #查找主机的hosts文件
     sudo vim /etc/hosts
     
     #修改文件
     sudo vim /etc/hosts
     
     #web:将下面网站信息和IP地址填写到文件中
     192.168.56.101  vn.sec.cuc.edu.cn
     192.168.56.101  dvwa.sec.cuc.edu.cn
     192.168.56.101  wp.sec.cuc.edu.cn
     ```

   + 配置`Nginx`

     ```
     #安装成功后，进入nginx目录，修改配置文件
     sudo vim /etc/nginx/sites-enabled/default
     
     #为避免后续安装 VeryNginx 时端口占用，将它的监听端口绑定到虚拟机host-only的IP地址的8000端口
     # 将端口修改为8000
     server {
     		listen 8000 default_server;
     
     #重新加载修改的配置文件
     sudo systemctl reload nginx 
     ```

   + 配置 `Wordpress`

     + 在 `MySQL` 中新建一个数据库用于 `wordpress`

       ```
       # 启动MySQL
       sudo mysql
       
       # 新建一个数据库 wordpress
       create database wordpress DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;
       
       # 创建用户
       create user 'wp_lxf'@'localhost' IDENTIFIED BY 'cuc123';
       
       #授权
       grant all on wordpress.* to 'wp_lxf'@'localhost';
       
       #刷新并退出
       flush privileges;
       exit;
       
       #重启mysql使配置文件生效
       sudo systemctl restart mysql.service 
       ```

     + 配置 `Wordpress` 的 `PHP` 文件

       ```
       #把目录wordpress的所有权分配给用户和组。
       sudo chown -R www-data:www-data /var/www/html/wp.sec.cuc.edu.cn/wordpress
       
       #进入目录下修改文件
       sudo vim /var/www/html/wp.sec.cuc.edu.cn/wordpress/wp-config-sample.php
       
       // ** MySQL settings - You can get this info from your web host ** //
       /** The name of the database for WordPress */
       define('DB_NAME', 'wordpress');
       
       /** MySQL database username */
       define('DB_USER', 'wp_lxf');
       
       /** MySQL database password */
       define('DB_PASSWORD', 'cuc123');
       
       /** MySQL hostname */
       define('DB_HOST', 'localhost');
       
       /** Database Charset to use in creating database tables. */
       define('DB_CHARSET', 'utf8');
       
       /** The Database Collate type. Don't change this if in doubt. */
       define('DB_COLLATE', '');
       
       # 将wp-config-sample.php更名为wp-config.php
       cd /var/www/html/wp.sec.cuc.edu.cn/wordpress/
       mv wp-config-sample wp-config
       ```

     + 配置服务器文件

       ```
       #创建新服务器块配置文件
       sudo vim /etc/nginx/sites-available/wp.conf
       
       #写入以下配置文件
       server {
           listen 8080 default_server;
       
           root /var/www/html/wp.sec.cuc.edu.cn;
           index index.php index.html index.htm index.nginx-debian.html;
           server_name wp.sec.cuc.edu.cn;
       
           location / {
               # try_files $uri $uri/ =404;
               try_files $uri $uri/ /index.php$is_args$args;
       
           }
       
           # 配置PHP-FPM进程的反向代理配置在nginx服务器上    
           location ~ \.php$ {
               include snippets/fastcgi-php.conf;
               fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
           }
       
           location ~ /\.ht {
               deny all;
           }
       }
       
       #创建从新服务器块配置文件到/etc/nginx/sites-enabled/目录的符号链接
       sudo ln -s /etc/nginx/sites-available/wp.conf /etc/nginx/sites-enabled/
       
       #取消链接默认配置文件
       sudo unlink /etc/nginx/sites-enabled/default
       
       #测试并重启nginx   
       sudo nginx -t
       systemctl restart nginx.service
       ```

       

       



